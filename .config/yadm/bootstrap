#!/bin/bash

set -e
set -x

system_type=$(uname -s)

if [ "$system_type" = "Darwin" ]; then

  # install homebrew if it's missing
  if ! command -v brew >/dev/null 2>&1; then
    echo "Installing homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi

  if [ -f "$HOME/.Brewfile" ]; then
    echo "Updating homebrew bundle"
    brew bundle --global
  fi

  # Migrate from fasd to zoxide if needed
  if command -v zoxide >/dev/null 2>&1 && [ -f "$HOME/.fasd" ] && [ ! -f "$HOME/.zoxide_migrated" ]; then
    echo "Migrating from fasd to zoxide"
    if [ -x "$HOME/bin/migrate-fasd-to-zoxide.sh" ]; then
      "$HOME/bin/migrate-fasd-to-zoxide.sh"
      touch "$HOME/.zoxide_migrated"
    fi
  fi

  # Setup fzf key bindings and fuzzy completion
  if command -v fzf >/dev/null 2>&1 && ! [ -f "$HOME/.fzf.zsh" ]; then
    echo "Setting up fzf shell integration"
    $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc
  fi

  if [ ! -f "$HOME/.iterm2_shell_integration.zsh" ]; then
    curl -L https://iterm2.com/shell_integration/zsh \
      -o ~/.iterm2_shell_integration.zsh
  fi

  if [[ $(sysctl -n machdep.cpu.brand_string) =~ "Apple" ]]; then
    softwareupdate --install-rosetta --agree-to-license
  fi

elif [ "$system_type" = "Linux" ]; then
  
  if ! command -v zsh >/dev/null 2>&1; then
    echo 'Install zsh first'
    exit 1
  fi

  sudo apt-get update
  sudo apt-get install -y \
    python3-pip \
    curl \
    wget \
    jq \
    tree \
    bat \
    direnv \
    fzf

  # Install modern tools via cargo if available
  if command -v cargo >/dev/null 2>&1; then
    cargo install eza zoxide ripgrep
  else
    echo "Warning: cargo not found, install modern tools manually"
    echo "For eza: https://github.com/eza-community/eza/blob/main/INSTALL.md"
    echo "For zoxide: https://github.com/ajeetdsouza/zoxide/releases"
    echo "For ripgrep: https://github.com/BurntSushi/ripgrep/releases"
    # Fallback to apt for ripgrep if available
    sudo apt-get install -y ripgrep || echo "ripgrep not available in apt, install manually"
  fi

  if ! command -v jenv >/dev/null 2>&1; then
    echo "Setting up jenv"
    if [ -d "$HOME/.jenv" ]; then
      echo "jenv directory exists, updating instead of installing"
      if [ -d "$HOME/.jenv/.git" ]; then
        git -C "$HOME/.jenv" pull --ff-only
      else
        echo "Warning: $HOME/.jenv exists but is not a git repo. Renaming and reinstalling"
        mv "$HOME/.jenv" "$HOME/.jenv.bak.$(date +%Y%m%d%H%M%S)"
        git clone https://github.com/jenv/jenv.git "$HOME/.jenv"
      fi
    else
      git clone https://github.com/jenv/jenv.git "$HOME/.jenv"
    fi
    
    # Ensure jenv is in PATH for this session
    export PATH="$HOME/.jenv/bin:$PATH"
    eval "$(jenv init -)"
  fi

  # Install Coursier if not available
  if ! command -v coursier >/dev/null 2>&1; then
    echo "Installing Coursier"

    curl -fLo coursier https://github.com/coursier/launchers/raw/master/coursier &&
    chmod +x coursier
    
    ./coursier setup --yes
        
    export PATH="$PATH:$HOME/.local/share/coursier/bin"
  fi

fi

# Zinit and Powerlevel10k are installed automatically by .zshrc on first run

coursier java-home --jvm 19 | xargs jenv add
coursier java-home --jvm 11 | xargs jenv add
coursier install scala-cli
coursier install coursier
coursier install scala
coursier install scalac
coursier install sbt
coursier install giter8
coursier install scala3
coursier install scalafix
coursier install --contrib plantuml

pipx install cfv toms

NPM_PACKAGES_DIR="${HOME}/.npm-packages"
[ -d "$NPM_PACKAGES_DIR" ] || mkdir "$NPM_PACKAGES_DIR"

